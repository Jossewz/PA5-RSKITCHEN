<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <title>Gestión de Mesas | Kitchen</title>
    <link rel="stylesheet" th:href="@{/css/mesa.css}">
</head>
<body>
<style>

</style>
<nav class="menu-bar">
    <ul>
        <li><a href="/home" sec:authorize="hasAnyAuthority('ROLE_ADMIN','ROLE_MESERO')">Inicio</a></li>
        <li><a href="/mesa"  class="active" sec:authorize="hasAnyAuthority('ROLE_ADMIN','ROLE_MESERO')">Mesa</a></li>
        <li><a href="/pedidos" sec:authorize="hasAnyAuthority('ROLE_ADMIN','ROLE_MESERO')">Pedidos</a></li>
        <li><a href="/factura" sec:authorize="hasAnyAuthority('ROLE_ADMIN','ROLE_MESERO')">Facturas</a></li>
        <li><a href="/mesero" sec:authorize="hasAuthority('ROLE_ADMIN')">Mesero</a></li>
        <li><a href="/platillos" sec:authorize="hasAuthority('ROLE_ADMIN')">Platillos</a></li>
        <li><a href="/datos" sec:authorize="hasAnyAuthority('ROLE_ADMIN')">Datos</a></li>
        <li class="logout-nav">
            <form th:action="@{/logout}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit">Cerrar Sesión</button>
            </form>
        </li>
    </ul>
</nav>

<h1>Gestión de Mesas</h1>

<input type="text" id="barraBusqueda" placeholder="Buscar mesas por número o estado..." onkeyup="filtrarMesas()" />

<div class="mesa-card">
    <h2>Crear nueva mesa</h2>
    <form th:action="@{/mesa/crear}" method="post" th:object="${nuevaMesa}">
        <label>Número de mesa:</label>
        <input type="number" th:field="*{num}" min="1" required />
        <button type="submit">Crear Mesa</button>
    </form>
</div>

<div th:if="${mensajeExito}" class="mensaje-exito" th:text="${mensajeExito}"></div>
<div th:if="${mensajeError}" class="mensaje-error" th:text="${mensajeError}"></div>

<h2 style="text-align:center; margin-top:40px;">Mesas existentes</h2>
<div id="listaMesas">
    <div th:each="mesa : ${listar}" class="mesa-card">
        <form th:action="@{'/mesa/' + ${mesa.id} + '/generar-factura'}" method="post" style="margin-top:10px;">
            <button type="submit"
                    th:disabled="${mesa.pedidosId == null or #lists.isEmpty(mesa.pedidosId)}"
                    onclick="return confirm('¿Seguro que deseas generar la factura y liberar esta mesa?');">
                Generar Factura y Liberar Mesa
            </button>
        </form>

        <h3>Mesa <span th:text="${mesa.num}"></span></h3>
        <p><strong>Estado:</strong>
            <span th:if="${mesa.ocupado}" style="color:red;">Ocupada</span>
            <span th:unless="${mesa.ocupado}" style="color:green;">Disponible</span>
        </p>
        <p><strong>Mesero:</strong>
            <span th:text="${nombresMeseros[mesa.id]} ?: 'No asignado'"></span>
        </p>

        <div th:if="${pedidosPorMesa[mesa.id] != null and !pedidosPorMesa[mesa.id].isEmpty()}">
            <h4>Pedidos:</h4>
            <div th:each="pedido : ${pedidosPorMesa[mesa.id]}" class="pedido-card">
                <p><strong>Fecha:</strong>
                    <span th:text="${#temporals.format(pedido.fecha, 'dd/MM/yyyy HH:mm')}"></span></p>
                <p><strong>Total:</strong>
                    <span th:text="${'$' + #numbers.formatDecimal(pedido.total, 1, 2)}"></span></p>
                <p><strong>Mesero:</strong>
                    <span th:text="${pedido.nombreMesero} ?: 'No asignado'"></span></p>
                <p><strong>Estado:</strong>
                    <span th:text="${pedido.pagado} ? 'Pagado' : 'Pendiente'"></span></p>

                <h5>Platillos:</h5>
                <div th:each="item : ${pedido.items}" class="platillo-item">
                    <p><strong th:text="${item.nombrePlatillo}"></strong></p>
                    <p th:text="${item.descripcionPlatillo}"></p>
                    <p>Cantidad: <span th:text="${item.cantidad}"></span></p>
                    <p>Precio: <span th:text="${'$' + #numbers.formatDecimal(item.precio, 1, 2)}"></span></p>
                </div>
            </div>
        </div>

        <div th:if="${pedidosPorMesa[mesa.id] == null or pedidosPorMesa[mesa.id].isEmpty()}">
            <p>No hay pedidos para esta mesa.</p>
        </div>
    </div>
</div>
<script th:src="@{/js/Confirmacion.js}"></script>
<script th:src="@{/js/filtromesa.js}"></script>
</body>
</html>

